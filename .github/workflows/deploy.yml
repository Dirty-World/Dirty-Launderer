name: Deploy The Dirty Launderer Bot to GCP

# Trigger deployment on push to main or manual workflow_dispatch
on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Zip bot source code
      run: |
        mkdir -p dist
        cd bot && zip -r ../dist/bot-source.zip .

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        workload_identity_provider: "projects/60107979354/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider"
        service_account: "github-deployer@the-dirty-launderer.iam.gserviceaccount.com"

    - name: Set up gcloud CLI
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Upload bot source to GCS
      run: gsutil cp dist/bot-source.zip gs://$GCS_BUCKET_NAME/
      env:
        GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME }}

    - name: Get GitHub Token from Secret Manager
      id: get-token
      run: |
        echo "GITHUB_TOKEN=$(gcloud secrets versions access latest --secret=GITHUB_TOKEN)" >> $GITHUB_ENV

    - name: Trigger Infrastructure Deployment
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ env.GITHUB_TOKEN }}
        repository: Dirty-World/dirty-launderer-infra
        event-type: deploy-infrastructure
        client-payload: |
          {
            "environment": "${{ github.event.inputs.environment || 'dev' }}",
            "source_version": "${{ github.sha }}"
          }

    - name: Notify on Failure
      if: failure()
      run: echo "Deployment failed. Please check the logs."